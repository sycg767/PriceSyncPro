# 🔌 PriceSyncPro 浏览器插件

**New API 价格同步助手 - 一键自动同步版本**

---

## 💡 为什么需要浏览器插件？

Web 版本需要手动执行 SQL，而**浏览器插件可以直接调用 New API 的管理接口，实现真正的一键同步**。

### 核心优势
- ✅ **无需 API Token**：自动使用浏览器登录状态
- ✅ **一键完成**：分析 → 同步 → 更新，全自动
- ✅ **智能合并**：只更新当前渠道，保留其他配置
- ✅ **实时反馈**：显示详细的更新进度和结果

---

## 📦 安装步骤

### Chrome / Edge 浏览器

1. **打开扩展管理页面**
   - Chrome：在地址栏输入 `chrome://extensions/`
   - Edge：在地址栏输入 `edge://extensions/`

2. **启用开发者模式**
   - 找到页面右上角的"开发者模式"开关
   - 点击开启

3. **加载扩展**
   - 点击"加载已解压的扩展程序"按钮
   - 选择 `PriceSyncPro-Extension` 文件夹
   - 点击"选择文件夹"

4. **完成安装**
   - 扩展图标会出现在浏览器工具栏
   - 可以点击"固定"图标以便快速访问

---

## 🎮 使用方法

### 第一步：登录 New API 后台

打开你的 New API 管理后台并登录：
```
https://your-newapi-domain.com/
```

**重要**：必须先登录，插件才能使用浏览器的 Cookie 进行认证。

### 第二步：打开插件

在任意 New API 页面，点击浏览器工具栏中的 **PriceSyncPro** 图标。

### 第三步：分析上游价格

1. **输入上游定价 URL**
   ```
   示例：https://api.example.com/api/pricing
   ```

2. **输入模型前缀**（可选）
   ```
   示例：KYX/
   留空则不添加前缀
   ```

3. **点击"🔍 开始分析上游价格"**

4. **查看分析结果**
   - 推断基础价格
   - 置信度
   - 匹配的模型数量
   - 详细价格列表

### 第四步：一键同步

1. **点击"🚀 一键同步到后台"按钮**

2. **等待同步完成**
   - 插件会显示实时进度
   - 依次更新 ModelPrice、ModelRatio、CompletionRatio

3. **查看更新统计**
   ```
   ✅ ModelPrice: 10 个模型已更新
   ✅ ModelRatio: 8 个模型已更新
   ✅ CompletionRatio: 8 个模型已更新
   ```

### 第五步：验证结果

前往 New API 后台验证：
```
设置 → 运营设置 → 模型倍率设置
```

检查几个常用模型的价格是否正确更新。

---

## 🔧 工作原理

### 为什么插件可以直接调用 API？

**关键技术**：Content Script + Session Cookie

```
浏览器插件的优势：
├─ 运行在 New API 页面中（同源）
├─ 自动携带登录 Cookie
├─ 可以直接调用管理接口
└─ 无需 API Token
```

### 与 Web 版本的区别

| 特性 | Web 版本 | 插件版本 |
|------|---------|---------|
| **运行环境** | file:// 协议 | https:// 同源 |
| **认证方式** | 需要 API Token | 自动使用 Cookie |
| **API 权限** | ❌ 无法访问管理接口 | ✅ 完全访问 |
| **操作方式** | 生成 SQL → 手动执行 | 直接 API 调用 |

---

## ⚠️ 使用注意事项

### 1. 必须先登录

插件依赖浏览器的登录状态：
- ✅ 登录后可以正常使用
- ❌ 未登录会提示"认证失败"

**解决方法**：在 New API 页面重新登录

### 2. Session 过期

如果长时间未操作，Session 可能过期：
- 表现：点击同步后提示"认证失败"
- 解决：刷新页面并重新登录

### 3. 上游 URL 格式

确保上游 URL 格式正确：
```
✅ 正确：https://api.example.com/api/pricing
✅ 正确：https://api.example.com/pricing
❌ 错误：api.example.com（缺少协议）
❌ 错误：https://example.com（错误的路径）
```

### 4. 前缀设置

- **有前缀**：所有模型名前会加上前缀（如 `KYX/gpt-4o`）
- **无前缀**：直接使用原始模型名（如 `gpt-4o`）
- **自动识别**：如果输入渠道 URL，会自动提取渠道名作为前缀

---

## 🐛 常见问题

### Q1: 点击插件图标没反应

**可能原因**：
- 扩展未正确加载
- 不在 New API 域名下

**解决方法**：
1. 打开 `chrome://extensions/`
2. 找到 PriceSyncPro，点击"重新加载"
3. 确认当前页面是 New API 后台页面
4. 刷新页面后重试

### Q2: 提示"认证失败"

**原因**：未登录或 Session 过期

**解决方法**：
1. 在 New API 页面重新登录
2. 刷新页面
3. 重新打开插件

### Q3: 分析失败

**可能原因**：
- 上游 URL 不正确
- 上游服务器无法访问
- 网络问题

**解决方法**：
1. 在浏览器中直接访问上游 URL，确认可以打开
2. 检查 URL 格式是否正确
3. 打开浏览器控制台（F12）查看错误信息

### Q4: 同步失败

**可能原因**：
- 没有修改配置的权限
- API 接口错误

**解决方法**：
1. 确认登录账号有管理员权限
2. 打开浏览器控制台（F12）查看详细错误
3. 检查 New API 版本是否支持 `/api/option/` 接口

### Q5: 价格不准确

**原因**：置信度较低或上游数据不完整

**解决方法**：
1. 查看分析结果中的"置信度"
2. 如果低于 90%，建议手动核对几个常用模型
3. 对比官方价格：`官方价格 / model_ratio = 基础价`

---

## 🔐 安全性说明

### 插件是否安全？

✅ **完全安全**：
- 开源透明，所有代码可审查
- 仅在本地运行，不连接第三方服务器
- 使用浏览器标准 Cookie 机制
- 最小权限原则

### 隐私保护

- ❌ 不收集任何用户数据
- ❌ 不跟踪用户行为
- ❌ 不上传任何信息到外部服务器
- ✅ 配置仅保存在本地（Chrome Storage）

### 权限说明

插件需要的权限：
```json
{
  "activeTab": "读取当前标签页信息",
  "storage": "保存用户配置（上游URL、前缀）",
  "host_permissions": "在任意页面运行（用于获取上游数据和调用API）"
}
```

---

## 📁 文件结构

```
PriceSyncPro-Extension/
├── manifest.json           # 扩展配置文件
├── popup.html             # 插件弹出窗口界面
├── popup.js               # 插件 UI 逻辑
├── content.js             # 核心同步脚本（注入页面）
├── background.js          # 后台服务
├── official_prices.json   # 官方价格数据库
├── icons/                 # 扩展图标
└── README.md              # 本文档
```

---

## 🆚 选择建议

### 使用 Web 版本的场景
- ✅ 有数据库直接访问权限
- ✅ 只需要偶尔更新价格
- ✅ 不想安装浏览器扩展

### 使用插件版本的场景
- ✅ 只有后台登录权限（没有数据库权限）
- ✅ 需要频繁更新价格
- ✅ 想要真正的"一键同步"体验

---

## 📄 开源协议

MIT License - 可自由使用、修改、分发

---

**PriceSyncPro | 智能价格同步工具**
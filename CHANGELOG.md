# 更新日志 (Changelog)

所有重要的项目变更都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [2.1.2] - 2025-11-23

### ✨ 新增功能

- **🛡️ Cloudflare 验证绕过（重大更新）**
  - **问题背景**: 部分上游网站使用Cloudflare人机验证，导致插件请求返回HTTP 403错误
  - **解决方案**: 实现标签页脚本注入方案，通过真实浏览器环境发起请求
  - **技术实现**:
    - 自动打开隐藏标签页访问目标URL，完成Cloudflare验证
    - 验证成功后，在标签页内注入脚本发起API请求
    - 复用浏览器Cookie和会话，绕过人机检测
    - 请求完成后自动关闭标签页
  - **用户体验**: 完全自动化，无需用户手动操作，透明处理验证流程
  - **兼容性**: 支持所有启用了Cloudflare防护的上游API

- **🔄 完整的请求头模拟**
  - **User-Agent**: 模拟真实Chrome浏览器
  - **Accept系列**: 完整的Accept、Accept-Language、Accept-Encoding
  - **Client Hints**: Sec-CH-UA、Sec-CH-UA-Mobile、Sec-CH-UA-Platform
  - **安全头**: Sec-Fetch-Dest、Sec-Fetch-Mode、Sec-Fetch-Site
  - **其他**: Referer、Origin、DNT等，完全模拟浏览器行为

- **⚡ 请求重试机制**
  - **智能重试**: 失败后自动重试，最多3次
  - **随机延迟**: 每次重试间隔随机延迟(500-2000ms)，模拟人类行为
  - **指数退避**: 逐步增加重试间隔，避免触发限流

### 🐛 Bug修复

- **HTTP 403 错误处理**
  - **根本原因**: Cloudflare人机验证检测到自动化请求
  - **解决方案**: 使用标签页脚本注入，从真实浏览器环境发起请求
  - **影响范围**: 解决所有带Cloudflare防护的上游API请求失败问题

- **自动配置模式前缀问题**
  - **问题修复**: 修复自动配置模式在执行完整同步时使用了快速模式前缀的bug
  - **根本原因**: `performCompleteSyncLogic` 函数固定调用 `getNormalizedPrefix()`，该函数只读取快速模式的输入框
  - **解决方案**: 添加模式判断逻辑，根据 `currentMode` 动态获取正确的前缀
  - **影响范围**: 现在自动配置模式会正确使用其自己输入框中的前缀

- **自动配置URL记忆功能**
  - **保存逻辑**: 新增URL输入框的 `input` 事件监听，自动保存配置
  - **加载逻辑**: 添加 `autoConfigApiPathCustom` 到storage加载列表，恢复自定义路径
  - **完整支持**: 自动配置模式的所有字段（URL、API路径、前缀、密钥、标签）现在都会被自动保存和恢复

### 🔒 安全

- **敏感信息检查**
  - **全面审查**: 检查项目中所有文件，确认没有硬编码的URL和API密钥
  - **用户数据保护**: 用户输入的URL和密钥存储在 `chrome.storage.local`（本地浏览器存储）
  - **Git安全**: 确认.gitignore配置正确，不会将用户配置提交到仓库
  - **推送安全**: 确认项目可以安全推送到GitHub，不会泄露任何敏感信息

### 📝 代码质量

- **逻辑优化**: 改进前缀获取逻辑，确保模式切换时使用正确的输入源
- **配置持久化**: 完善自动配置模式的配置保存和加载机制

---

## [2.1.1] - 2025-11-22

### 🎨 UI/UX优化

- **自定义API路径输入优化**
  - **智能显示/隐藏**: 当API路径下拉框选择"custom"时，自动显示自定义路径输入框
  - **双模式支持**: 快速同步和自动配置模式均支持此功能
  - **用户体验提升**: 减少视觉干扰，只在需要时显示自定义输入框

- **模式切换状态管理**
  - **只读状态修复**: 修复模式切换时输入框只读状态不正确的问题
  - **自动重置**: 切换到自动配置模式时，自动移除输入框的只读限制
  - **智能恢复**: 避免状态残留，确保用户体验流畅

- **按钮文本优化**
  - **消除歧义**: 快速同步模式按钮显示"开始同步"，自动配置模式显示"创建并同步"
  - **模式专属**: 批量更新按钮仅在快速同步模式显示，自动配置模式自动隐藏
  - **上下文感知**: `updateSmartSyncButton()` 函数根据当前模式显示对应的按钮文本

### 🐛 Bug修复

- **进度条时机**: 修复批量更新完成后进度条延迟隐藏导致的视觉重叠问题
- **搜索统计**: 修复表格搜索清空时统计信息未恢复原始数据的问题

### 📝 代码质量

- **逻辑优化**: 改进 `switchMode()` 函数，确保模式切换时所有UI状态正确更新
- **可维护性**: 统一按钮状态管理逻辑，减少代码重复

---

## [2.1.0] - 2025-11-21

### ✨ 新增功能

- **🔄 批量更新所有渠道**
  - **智能批量处理**: 新增"批量更新所有渠道"功能，一键更新所有渠道的价格配置
  - **自动API检测**: 智能尝试 New API (`/api/pricing`) 和 One Hub (`/api/available_model`) 两种API路径
  - **实时进度显示**: 批量处理时显示详细的进度条和当前处理的渠道
  - **详细错误报告**: 失败时显示每个API路径的具体错误信息，方便排查问题

- **📝 URL输入优化**
  - **分离式输入**: 将URL输入框拆分为"基础URL"和"API路径"两部分
  - **下拉选择器**: API路径支持下拉选择（`/api/pricing`、`/api/available_model`、自定义）
  - **自动拼接**: 自动拼接完整URL，用户体验更友好
  - **向后兼容**: 完全兼容旧版本的URL格式，自动转换

- **🏷️ 渠道前缀优化**
  - **智能补全**: 用户输入前缀时无需手动添加末尾的 `/`，系统自动处理
  - **友好显示**: 输入框显示时自动去除末尾 `/`，内部使用时自动添加
  - **标签更新**: 从"模型前缀"改为"渠道前缀"，更符合实际用途

### ♻️ 重构

- **URL处理逻辑**
  - 新增 `getFullUpstreamUrl()` 和 `setFullUpstreamUrl()` 函数
  - 创建虚拟 `upstreamUrlInput` 对象，保持向后兼容
  - 优化配置加载和保存逻辑，同时支持新旧格式

- **前缀处理逻辑**
  - 新增 `getNormalizedPrefix()` 和 `setPrefix()` 函数
  - 统一前缀处理逻辑，避免重复代码

### 🎨 UI/UX优化

- **双模式同步**: 快速同步模式和自动配置模式均支持新的URL输入方式
- **实时同步**: 两种模式的输入字段自动双向同步
- **视觉优化**: 自定义路径输入框按需显示/隐藏

### 🐛 Bug修复

- **API路径检测**: 修复批量更新时只尝试单一API路径的问题
- **错误信息**: 优化失败原因显示,提供更详细的诊断信息

---

## [2.0.0] - 2025-11-20

### ✨ 新增功能

- **🚀 一键自动配置模式**
  - **全新工作流**: 新增“自动配置”模式，允许用户通过填写上游 URL、模型前缀和 API 密钥，一键完成渠道、供货商及模型配置的自动创建。
  - **智能判断**: 插件能自动检测配置是否已存在，避免重复创建。
  - **无缝集成**: 自动配置完成后，流程将无缝衔接至完整的模型列表和价格同步，实现从零到可用的全自动化。

- **UI/UX 全面革新**
  - **双模式切换器**: 引入 iOS 风格的 Segmented Control，在“快速同步”和“自动配置”两种模式间轻松切换，使不同场景下的操作路径更清晰。
  - **统一的“智能同步”按钮**: 替换了原有的多个独立按钮，现在一个按钮即可根据当前上下文（是否选择渠道、处于何种模式）智能执行最合适的操作（仅价格、完整同步、自动配置）。
  - **增强的视觉反馈**: 优化了模态对话框、信息提示条和输入验证的 UI，风格更统一，反馈更及时。

### ♻️ 重构

- **项目结构扁平化**: 移除 `PriceSyncPro-Extension` 和 `PriceSyncPro-WebVersion` 目录，将插件核心文件提升至项目根目录。这使项目结构更符合标准浏览器插件的规范，方便用户打包和理解。
- **代码逻辑优化**: 重构了 `popup.js` 中的事件处理逻辑，以支持新的双模式切换和统一的“智能同步”按钮，代码更清晰，可维护性更高。

### ⚠️ 废弃

- **移除 Web 版本**: 正式废弃并移除 `PriceSyncPro-WebVersion` 目录及其所有相关文件，项目现在完全专注于提供更强大、更便捷的浏览器插件体验。

### 🐛 Bug修复

- **按钮状态恢复**: 修复了在“自动配置”模式下，操作完成后按钮状态卡在“更新中”而无法恢复的 bug。

### 📝 文档

- **README.md 全面重写**:
  - 文档内容完全聚焦于浏览器插件，移除了所有关于 Web 版本的描述。
  - 更新了安装步骤和快速开始指南，以反映新的目录结构和双模式工作流。
  - 重新设计了功能介绍，重点突出“一键自动配置”和“智能同步”的核心优势。

---

## [1.2.1] - 2025-11-16

### 🐛 Bug修复
- **OneHub平台兼容性**：修复/pricing接口数据格式兼容性问题
  - 添加OneHub对象格式自动检测和转换
  - 优化令牌组过滤逻辑，兼容无令牌组信息的数据

---

## [1.2.0] - 2025-11-16

### ✨ 新增功能

#### UI/UX 全面优化
- **高优先级优化**
  - 按钮状态反馈：禁用按钮显示清晰的tooltip说明（带❌图标）
  - 加载状态优化：添加进度条UI组件，实时显示同步进度（10% → 40% → 70% → 100%）
  - 错误消息优化：统一格式，使用换行符替代HTML标签，提升可读性

- **中优先级优化**
  - 渠道选择简化：显示格式从 `渠道名 (ID: X, Y个模型)` 简化为 `渠道名 (Y个)`
  - 预设管理优化：列表和下拉框显示URL域名，提高识别度
  - 快捷键提示：在按钮tooltip中显示 Ctrl+Enter 和 Ctrl+S

- **低优先级优化**
  - 输入提示转tooltip：将3个输入提示转换为title属性，减少视觉干扰
  - 智能价格精度：根据价格大小动态调整显示精度（≥$1显示2位，≥$0.01显示4位，<$0.01显示6位）
  - 代码清理：移除冗余的syncBtn引用

### 🐛 Bug修复
- **403错误处理**：扩展错误回退机制，支持403状态码自动回退到/pricing接口
- **错误标识统一**：将`401_FALLBACK`改为`AUTH_FALLBACK`，更通用的认证错误标识

### 🎨 性能优化
- 使用DocumentFragment批量插入DOM，减少重排次数
- 优化表格渲染性能，提升大量模型时的显示速度

### 📚 文档更新
- 更新README，补充UI/UX优化说明
- 完善CHANGELOG，记录所有新功能和修复

---

## [1.1.0] - 2025-11-06

### ✨ 新增功能

#### One Hub API 完整支持
- **多格式兼容**
  - 支持 One Hub 官方 API 格式（`/api/available_model`）
  - 支持 One Hub 实例 API 格式（`/panel/model_price`）
  - 自动检测和转换两种 One Hub 数据格式
  
- **智能价格转换**
  - 自动处理 One Hub 内部单位（÷500）
  - 智能转换 $/1K 到 $/1M（按量计费模型）
  - 正确处理按次计费模型价格
  - 自动识别免费模型（input ≤ 0 && output ≤ 0）

- **用户体验优化**
  - 插件和 Web 版本均添加 API 端点提示
  - 清晰标注 New API 和 One Hub 的端点路径
  - 简化用户输入，减少错误

### 📚 文档更新
- 更新使用指南，添加 One Hub 使用说明
- 完善 README，补充 One Hub 支持信息
- 更新 CHANGELOG，记录所有新功能

### 🔧 技术改进
- 优化格式检测逻辑，提升兼容性
- 增强错误处理，更友好的错误提示
- 代码重构，提高可维护性

---

## [1.0.0] - 2025-11-05

### 🎉 首个正式版发布

这是 PriceSyncPro 的第一个正式版本，提供完整的价格同步功能。

### ✨ 新增功能

#### 核心功能
- **智能价格推断引擎**
  - 使用"众数投票"算法自动推断上游系统的隐藏基础价
  - 支持置信度评估，确保推断结果可靠
  - 自动匹配 120+ 主流 AI 模型的官方价格

- **双模式计费支持**
  - 按次计费（Per-Use）：直接计算单次调用价格
  - 按量计费（Usage-Based）：计算 ModelRatio 和 CompletionRatio

- **智能 SQL 生成器**
  - 合并模式：只更新当前前缀的模型，保留其他配置
  - 带备份模式：自动创建备份表，安全可靠
  - 支持自定义模型前缀

#### 浏览器插件版
- **一键自动同步**
  - 无需手动执行 SQL，点击按钮即可完成
  - 实时显示同步进度和结果
  - 支持批量同步和单个同步

- **智能配置管理**
  - 自动读取现有配置
  - 智能合并新旧配置
  - 支持多字段编辑对话框

- **性能优化**
  - 按需注入 Content Script，减少 40%+ 资源消耗
  - DocumentFragment 批量渲染，提升 60%+ 性能
  - 智能错误处理，只显示关键警告

#### Web 版
- **现代化 UI 设计**
  - iOS 风格界面，美观易用
  - 响应式布局，支持各种屏幕尺寸
  - 流畅的动画效果

- **数据导出功能**
  - 支持 CSV 格式导出
  - 一键复制表格数据
  - 完整的价格分析报告

- **使用指南和文档**
  - 内置详细使用指南
  - 关于页面展示项目信息
  - 快速开始教程

### 📚 文档
- 完整的 README.md 使用文档
- 浏览器插件安装和使用指南
- Web 版本部署说明
- FAQ 常见问题解答

### 🔧 技术实现
- 使用 Chrome Extension Manifest V3
- 纯原生 JavaScript，无外部依赖
- 模块化代码结构，易于维护
- 完善的错误处理和日志系统

### 📦 发布内容
- 浏览器插件版（推荐）
- Web 版本
- 完整源代码
- 使用文档

---

## 版本号说明

版本格式：`主版本号.次版本号.修订号`

- **主版本号**：重大功能变更或不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

---

## 类型说明

- `✨ 新增`：新功能
- `🐛 修复`：Bug 修复
- `📝 文档`：文档更新
- `🎨 优化`：代码优化、性能提升
- `♻️ 重构`：代码重构
- `🔧 配置`：配置文件修改
- `⚠️ 废弃`：即将移除的功能
- `🗑️ 移除`：移除的功能
- `🔒 安全`：安全相关修复

---

[1.2.0]: https://github.com/sycg767/PriceSyncPro/releases/tag/v1.2.0
[1.1.0]: https://github.com/sycg767/PriceSyncPro/releases/tag/v1.1.0
[1.0.0]: https://github.com/sycg767/PriceSyncPro/releases/tag/v1.0.0